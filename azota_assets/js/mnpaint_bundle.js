!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.mnpaint=e():t.mnpaint=e()}(self,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function i(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function n(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function o(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}t.r(e),t.d(e,{getInstance:()=>r});var h=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),o(this,"_config",{width:0,height:0,border:"1px solid #CCCCCC",backgroundColor:"#CCCCCC",contentBackgroundColor:"#FFFFFF",blankWidth:720,blankHeight:540,exportType:"image/png",exportQuality:1,autoUpdateSource:"stop",stopWhenClickOutside:!0,resizable:!0}),o(this,"_selection",{type:"transform",connerSize:8,rect:{x:-1,y:-1,width:0,height:0}}),o(this,"_parent",null),o(this,"_zoom",1),o(this,"_his",null),o(this,"_hisIndex",-1),o(this,"_saveHandler",null),o(this,"_source",null),o(this,"_isReplaceSource",!1),o(this,"_textFormat",{fontFamily:"Arial",fontSize:18,fontStyle:"normal",textDecoration:"normal",fontWeight:"normal",backgroundColor:"transparent",color:"#000000"}),o(this,"_clientMouseX",-1),o(this,"_clientMouseY",-1),o(this,"_mnClipboard",null),o(this,"_useClipboard",!1),o(this,"_stateProcessing",-1),this._initCss(),this._onkeyup=this._onkeyup.bind(this),this._onkeypress=this._onkeypress.bind(this),this._onkeydown=this._onkeydown.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onRenderMouseDown=this._onRenderMouseDown.bind(this),this._onRenderMouseMove=this._onRenderMouseMove.bind(this),this._onWindowMouseMove=this._onWindowMouseMove.bind(this),this._onWindowMouseUp=this._onWindowMouseUp.bind(this),this._onWindowResizeMouseUp=this._onWindowResizeMouseUp.bind(this),this._onWindowMouseDown=this._onWindowMouseDown.bind(this),this._onTextMouseDown=this._onTextMouseDown.bind(this),this._onTextFocus=this._onTextFocus.bind(this),this._onTextLostFocus=this._onTextLostFocus.bind(this),this._onTextInput=this._onTextInput.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragLeave=this._onDragLeave.bind(this),this._onDrop=this._onDrop.bind(this),this._onPaste=this._onPaste.bind(this),this._onCopy=this._onCopy.bind(this),this._onElementMouseClick=this._onElementMouseClick.bind(this),this._onElementMouseDown=this._onElementMouseDown.bind(this),this._init(),this._addEventListener(),this.log("Start mnpaint version "+this.version)}var e,i;return e=t,(i=[{key:"version",get:function(){return"2.8"}},{key:"_initCss",value:function(){var t="._mnRender::-webkit-scrollbar {width: 7px;height:7px;}";t+="._mnRender::-webkit-scrollbar-track {background: #f1f1f1;}",t+="._mnRender::-webkit-scrollbar-thumb {background: #888;}",t+="._mnRender::-webkit-scrollbar-thumb:hover {background: #555;}",t+="._mnInput{margin:0;padding:0;border:0;}",t+="._mnInput::-webkit-color-swatch-wrapper {padding: 0;margin:0;background:none;}",t+='._mnInput::-webkit-color-swatch {border: "1px solid #CCCCCC";}',t+="._mnTextDiv {-ms-overflow-style: none;  /* Internet Explorer 10+ */scrollbar-width: none;  /* Firefox */}",t+="._mnTextDiv::-webkit-scrollbar { display: none;  /* Safari and Chrome */}";var e=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");e.appendChild(i),i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t))}},{key:"_init",value:function(){var t=this;this._editor=document.createElement("div"),this._editor.style.position="absolute",this._editor.classList.add("_mnEditor"),this._container=document.createElement("div"),this._container.classList.add("_mnContainer"),this._container.style.position="absolute",this._editor.appendChild(this._container),this._render=document.createElement("div"),this._render.style.position="absolute",this._render.style.top="0px",this._render.style.left="0px",this._render.classList.add("_mnRender"),this._container.appendChild(this._render),this._contentRender=document.createElement("div"),this._contentRender.style.position="absolute",this._contentRender.style.top="0px",this._contentRender.style.left="0px",this._contentRender.style.pointerEvents="none",this._contentRender.style.transformOrigin="0% 0%",this._contentRender.classList.add("_mnContentRender"),this._render.appendChild(this._contentRender),this._selectionRender=document.createElement("canvas"),this._selectionRender.style.position="absolute",this._selectionRender.style.top="0px",this._selectionRender.style.left="0px",this._selectionRender.style.pointerEvents="none",this._selectionRender.classList.add("_mnSelectionRender"),this._selectionCtx=this._selectionRender.getContext("2d"),this._render.appendChild(this._selectionRender),this._imgCanvas=document.createElement("canvas"),this._imgCanvas.style.position="absolute",this._imgCanvas.style.top="0px",this._imgCanvas.style.left="0px",this._imgCanvas.classList.add("_mnImgCanvas"),this._imgCanvas.style.pointerEvents="none",this._imgCanvas.width=0,this._imgCanvas.height=0,this._imgCtx=this._imgCanvas.getContext("2d"),this._contentRender.appendChild(this._imgCanvas),this._textLayer=document.createElement("div"),this._textLayer.position="absolute",this._textLayer.style.top="0px",this._textLayer.style.left="0px",this._textLayer.classList.add("_mnTextLayer"),this._contentRender.appendChild(this._textLayer),this._edMenu=this._createEditorContextMenu(),this._texMenu=this._createTextFormatMenu(),this._brushMenu=this._createMenuBrush(),this.makeDragable(this._texMenu),this.makeDragable(this._brushMenu),this._applyConfig(),this._fileInput=document.createElement("input"),this._fileInput.setAttribute("type","file"),this._fileInput.style.display="none",this._fileInput.setAttribute("accept","accept/*"),this._render.appendChild(this._fileInput),this._fileInput.addEventListener("change",(function(e){t._fileInput.files.length>0&&t._handleImageFile(t._fileInput.files[0])}))}},{key:"_addEventListener",value:function(){this._addKeyboardEvent(),this._render.addEventListener("mousedown",this._onRenderMouseDown),this._render.addEventListener("mousemove",this._onRenderMouseMove),this._render.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("mousedown",this._onWindowMouseDown),window.addEventListener("mouseup",this._onWindowResizeMouseUp),this._render.addEventListener("dragover",this._onDragOver),this._render.addEventListener("dragleave",this._onDragLeave),this._render.addEventListener("drop",this._onDrop),document.addEventListener("paste",this._onPaste),document.addEventListener("copy",this._onCopy)}},{key:"_removeEventListener",value:function(){this._removeKeyboardEvent(),this._render.removeEventListener("mousedown",this._onRenderMouseDown),this._render.removeEventListener("mousemove",this._onRenderMouseMove),this._render.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("mousedown",this._onWindowMouseDown),window.removeEventListener("mouseup",this._onWindowResizeMouseUp),this._render.removeEventListener("dragover",this._onDragOver,!1),this._render.removeEventListener("dragleave",this._onDragLeave,!1),this._render.removeEventListener("drop",this._onDrop,!1),document.removeEventListener("paste",this._onPaste),document.removeEventListener("copy",this._onCopy)}},{key:"_onWindowMouseDown",value:function(t){if(this._texMenu.parentNode)this.hitTest(t.clientX,t.clientY,this._texMenu)||this._hideTextFormatMenu();else if(this._edMenu.parentNode)this.hitTest(t.clientX,t.clientY,this._edMenu)||this._hideEditorContextMenu();else if(this._brushMenu.parentNode){if(this.hitTest(t.clientX,t.clientY,this._brushMenu))return;this.hitTest(t.clientX,t.clientY,this._render)||this._setSelectionType("normal")}else{for(var e=!1;this._textLayer.firstChild;)this._drawTextDiv(this._textLayer.firstChild),e=!0;!this._config.stopWhenClickOutside||this.hitTest(t.clientX,t.clientY,this._render)||e||this.stopSession()}}},{key:"_onWindowResizeMouseUp",value:function(t){var e=parseInt(this._render.style.width),i=parseInt(this._render.style.height);e==this._config.width&&i==this._config.height||this.setConfig({width:e,height:i})}},{key:"_onDragOver",value:function(t){this._render.style.border="1px solid #FF0000",t.preventDefault(),t.stopPropagation()}},{key:"_onDragLeave",value:function(t){this._render.style.border=this._config.border,t.preventDefault(),t.stopPropagation()}},{key:"_onDrop",value:function(t){if(this._render.style.border=this._config.border,t.preventDefault(),t.stopPropagation(),t.dataTransfer.items){for(var e=0;e<t.dataTransfer.items.length;e++)if("file"===t.dataTransfer.items[e].kind){var i=t.dataTransfer.items[e].getAsFile();this._handleImageFile(i)}}else for(var n=0;n<t.dataTransfer.files.length;n++)this._handleImageFile(t.dataTransfer.files[n])}},{key:"_onPaste",value:function(t){var e=t.clipboardData.items,i=[].slice.call(e).filter((function(t){return-1!==t.type.indexOf("image")}));if(this._useClipboard&&this._mnClipboard)this._handleImageFile(this._mnClipboard),delete this._mnClipboard;else if(i.length>0){var n=i[0].getAsFile();this._handleImageFile(n)}}},{key:"_onCopy",value:function(t){var e=this,i=this._selection.rect;if(this._selection.rect.width>0&&this._selection.rect.height>0){this._mnClipboard=n({},i);var s=document.createElement("canvas");s.width=i.width,s.height=i.height,s.getContext("2d").drawImage(this._imgCanvas,i.x,i.y,i.width,i.height,0,0,i.width,i.height),s.toBlob((function(t){try{e._mnClipboard=t,t.name="image.png";var i=[new ClipboardItem(o({},t.type,t))];navigator.clipboard?navigator.clipboard.write(i).then((function(){e.log("copy clipboard ok !"),e._useClipboard=!1}),(function(t){this.log("error copy image to clipboard !"),this._useClipboard=!0})):(e.log("Browser do not support Clipboard API"),e._useClipboard=!0)}catch(t){e._useClipboard=!0,e.log("use clipboard !")}}),"image/png")}}},{key:"_onContextMenu",value:function(t){this._showEditorContextMenu(),t.preventDefault(),t.stopPropagation()}},{key:"_reset",value:function(){"stop"==this._config.autoUpdateSource&&1==this._stateProcessing&&this._updateSource(this._imgCanvas.toDataURL(this._config.exportType,this._config.exportQuality)),this.zoom=1,this._his=[],this._hisIndex=-1,this._saveHandler=null,this._removeEventListener(),this._hideEditorContextMenu(),this._hideTextFormatMenu(),this._hideMenuBrush(),this._removeDivText(this.textDiv),this.removeAllChild(this._textLayer),this._clearSelection(),this._selectionStart=null,this._cvResize=null,this._cvImgSelection=null,this._cvSelection=null,this._config.width=0,this._config.height=0,this._imgCtx.clearRect(0,0,this._imgCanvas.width,this._imgCanvas.height),1==this._isReplaceSource?this._source&&1==this._stateProcessing&&this._editor.parentNode.replaceChild(this._source,this._editor):this._editor.parentNode&&this._editor.parentNode.removeChild(this._editor),this._source=null,this._parent=null,this._isReplaceSource=!1,this._stateProcessing=-1,this.clearAllAttribute(this._editor)}},{key:"log",value:function(t){var e=(new Date).toISOString(),i=e.substr(e.length-13,13)+"--"+t;console.log(i)}},{key:"makeDragable",value:function(t,e){t._azDragObj||(t._azDragObj={callbacks:[],downX:-1,downY:-1,startX:-1,startY:-1,onmousedown:function(t){var e=t.currentTarget,i=e._azDragObj;if(i){window.removeEventListener("mousemove",i.onwindowmousemove),window.removeEventListener("mouseup",i.onwindowmouseup);var n=e.getBoundingClientRect();Math.abs(n.x+n.width-t.clientX)<10&&Math.abs(n.y+n.height-t.clientY)<10||(i.downX=t.clientX,i.downY=t.clientY,i.startX=parseInt(e.style.left),i.startY=parseInt(e.style.top),window._azDragDom=e,window.addEventListener("mousemove",i.onwindowmousemove),window.addEventListener("mouseup",i.onwindowmouseup),i.callbacks.forEach((function(t){t.onstart&&t.onstart(e)})),t.stopPropagation())}},onwindowmousemove:function(t){var e=window._azDragDom;if(e){var i=e._azDragObj;if(i){var n=e.getBoundingClientRect();if(0!=n.width&&0!=n.height){var s,o,h=e.clientWidth,r=e.clientHeight;s=h/n.width,o=r/n.height;var a=Math.floor(i.startX+(t.clientX-i.downX)*s),l=Math.floor(i.startY+(t.clientY-i.downY)*o);e.style.top=l+"px",e.style.left=a+"px",i.callbacks.forEach((function(t){t.onmove&&t.onmove(e,a,l)}))}}}},onwindowmouseup:function(){var t=window._azDragDom;if(t){var e=t._azDragObj;e&&(e.downX=-1,e.downY=-1,e.startX=-1,e.startY=-1,window._azDragDom=null,window.removeEventListener("mousemove",e.onwindowmousemove),window.removeEventListener("mouseup",e.onwindowmouseup),e.callbacks.forEach((function(e){e.onend&&e.onend(t)})))}}}),e&&t._azDragObj.callbacks.push(e),t.addEventListener("mousedown",t._azDragObj.onmousedown)}},{key:"hitTest",value:function(t,e,i){if(!i||!i.parentNode)return!1;var n=i.getBoundingClientRect();return t>=n.x&&t<=n.x+n.width&&e>=n.y&&e<=n.y+n.height}},{key:"removeAllChild",value:function(t){if(t&&t instanceof HTMLElement)for(;t.firstChild;)t.removeChild(t.firstChild)}},{key:"getTransformValue",value:function(t){var e={scaleX:1,scaleY:1,rotate:1};if(!(t instanceof HTMLElement&&t.style&&t.style.transform))return e;var i=(t.style.transform.toString().toLowerCase().replaceAll(" ","")+"    ").replace(new RegExp("\\b"+["matrix","rotate","scaleX","scaleY","scale"].join("|")+"\\b","gi"),(function(t){return"    "+t})).split(")    ").reduce((function(t,e){var i=(e=e.trim()).slice(0,e.indexOf("(")),n=e.slice(e.indexOf("(")+1,999);return e?(t[i]?t[i].push(n):t[i]=[n],t):t}),{});return i.scaleX&&i.scaleX.length>0&&i.scaleX.forEach((function(t){isNaN(Number(t))||(e.scaleX*=t)})),i.scaleY&&i.scaleY.length>0&&i.scaleY.forEach((function(t){isNaN(Number(t))||(e.scaleY*=t)})),i.scale&&i.scale.length>0&&i.scale.forEach((function(t){t=t.split(","),isNaN(Number(t[0]))||(e.scaleX*=Number(t[0])),isNaN(Number(t[1]))?isNaN(Number(t[0]))||(e.scaleY*=Number(t[0])):e.scaleY*=Number(t[1])})),i.rotate&&i.rotate.length>0&&i.rotate.forEach((function(t){isNaN(parseInt(t))||(e.rotate*=parseInt(t))})),e}},{key:"copyAttributes",value:function(t,e){return Array.from(t.attributes).forEach((function(t){"id"===t.nodeName||t.nodeName,"src"===t.nodeName||t.nodeName,e.setAttribute(t.nodeName,t.nodeValue)}))}},{key:"clearAllAttribute",value:function(t){for(;t.attributes.length>0;)t.removeAttribute(t.attributes[0].name)}},{key:"setConfig",value:function(t){!isNaN(t.width)&&t.width>0&&(this._config.width=t.width),!isNaN(t.height)&&t.height>0&&(this._config.height=t.height),!isNaN(t.blankWidth)&&t.blankWidth>0&&(this._config.blankWidth=t.blankWidth),!isNaN(t.blankHeight)&&t.blankHeight>0&&(this._config.blankHeight=t.blankHeight),t.border&&"string"==typeof t.border&&(this._config.border=t.border),t.backgroundColor&&"string"==typeof t.backgroundColor&&(this._config.backgroundColor=t.backgroundColor),t.contentBackgroundColor&&"string"==typeof t.contentBackgroundColor&&(this._config.contentBackgroundColor=t.contentBackgroundColor),t.exportType&&"string"==typeof t.exportType&&(this._config.exportType=t.exportType),!isNaN(t.exportQuality)&&t.exportQuality>0&&t.exportQuality<=1&&(this._config.exportQuality=t.exportQuality),t.autoUpdateSource&&"string"==typeof t.autoUpdateSource&&(this._config.autoUpdateSource=t.autoUpdateSource),t.stopWhenClickOutside&&"boolean"==typeof t.stopWhenClickOutside&&(this._config.stopWhenClickOutside=t.stopWhenClickOutside),t.resizable&&"boolean"==typeof t.resizable&&(this._config.resizable=t.resizable),this._applyConfig()}},{key:"setTextFormat",value:function(t){this._setTextFormat(t)}},{key:"config",get:function(){return this._config}},{key:"_applyConfig",value:function(){this._render.style.backgroundColor=this._config.backgroundColor,this._render.style.border=this._config.border,1==this._config.resizable?this._render.style.resize="both":this._render.style.resize="none",this._contentRender.style.backgroundColor=this._config.contentBackgroundColor,this._render.style.width=this._config.width+"px",this._render.style.height=this._config.height+"px",this._container.style.width=this._config.width+"px",this._container.style.height=this._config.height+"px",this._editor.style.width=this._config.width+"px",this._editor.style.height=this._config.height+"px",this._clearSelection(),this._selectionRender.width=this._config.width,this._selectionRender.height=this._config.height,this._selectionCtx.translate(.5,.5),this._applyZoom()}},{key:"_onRenderMouseDown",value:function(t){if(2!=t.button){this._hideEditorContextMenu();var e=this._pointGlobalToContentSpace(t),i=this._selectionPointType(e.x,e.y);if("resize"==i){this._clearSelection(),this._cvResize=document.createElement("canvas");var n=this._cvResize.getContext("2d");this._cvResize.width=this._imgCanvas.width,this._cvResize.height=this._imgCanvas.height,n.drawImage(this._imgCanvas,0,0)}else"none"==i?"brush"!=this._selection.type&&(this._clearSelection(),this._selection.rect={x:e.x,y:e.y,width:0,height:0},this._drawSelection()):"inrect"==i&&"normal"==this._selection.type&&this._makeTransform();this._selectionStart=JSON.parse(JSON.stringify(this._selection)),this._selectionStart.stype=i,this._selectionStart.startX=e.x,this._selectionStart.startY=e.y,window.addEventListener("mousemove",this._onWindowMouseMove),window.addEventListener("mouseup",this._onWindowMouseUp),this._onWindowMouseDown(t),t.stopPropagation()}}},{key:"_onWindowMouseMove",value:function(t){if(this._selectionStart){var e=this._pointGlobalToContentSpace(t);if(!(Math.abs(e.x-this._selectionStart.startX)<1&&Math.abs(e.y-this._selectionStart.startY)<1)){var i=this._selectionStart.rect;if("resize"==this._selectionStart.stype){var n=e.x-this._selectionStart.startX,s=e.y-this._selectionStart.startY,o=Math.floor(this._cvResize.width+n),h=Math.floor(this._cvResize.height+s);this._imgCanvas.width=o,this._imgCanvas.height=h,this._imgCtx.fillStyle=this._config.contentBackgroundColor,this._imgCtx.fillRect(0,0,o,h),this._imgCtx.drawImage(this._cvResize,0,0),this._contentRender.style.width=o+"px",this._contentRender.style.height=h+"px",this._selectionStart.hasResize=!0}if("none"==this._selectionStart.stype){var r=Math.min(i.x,e.x),a=Math.max(i.x,e.x),l=Math.min(i.y,e.y),c=Math.max(i.y,e.y);this._selection.rect.x=r,this._selection.rect.y=l,this._selection.rect.width=a-r,this._selection.rect.height=c-l}if("inrect"==this._selectionStart.stype&&(n=e.x-this._selectionStart.startX,s=e.y-this._selectionStart.startY,this._selection.rect.x=this._selectionStart.rect.x+n,this._selection.rect.y=this._selectionStart.rect.y+s),"top"==this._selectionStart.stype){r=Math.min(i.x+i.width,e.x),a=Math.max(i.x+i.width,e.x),l=Math.min(i.y+i.height,e.y),h=(c=Math.max(i.y+i.height,e.y))-l;var d=(o=a-r)/i.width,_=h/i.height;this._selection.rect.x=r,this._selection.rect.y=l,this.key_shift?(d<_?(this._selection.rect.width=o,this._selection.rect.height=i.height*d):(this._selection.rect.width=i.width*_,this._selection.rect.height=h),this._selection.rect.x=i.x+i.width-this._selection.rect.width,this._selection.rect.y=i.y+i.height-this._selection.rect.height):(this._selection.rect.width=a-r,this._selection.rect.height=c-l)}"mtop"==this._selectionStart.stype&&(l=Math.min(i.y+i.height,e.y),c=Math.max(i.y+i.height,e.y),this._selection.rect.y=l,this._selection.rect.height=c-l),"right"==this._selectionStart.stype&&(r=Math.min(i.x,e.x),a=Math.max(i.x,e.x),l=Math.min(i.y+i.height,e.y),h=(c=Math.max(i.y+i.height,e.y))-l,d=(o=a-r)/i.width,_=h/i.height,this._selection.rect.x=r,this._selection.rect.y=l,this.key_shift?(d<_?(this._selection.rect.width=o,this._selection.rect.height=i.height*d):(this._selection.rect.width=i.width*_,this._selection.rect.height=h),this._selection.rect.x=i.x,this._selection.rect.y=i.y+i.height-this._selection.rect.height):(this._selection.rect.width=a-r,this._selection.rect.height=c-l)),"mright"==this._selectionStart.stype&&(r=Math.min(i.x,e.x),a=Math.max(i.x,e.x),this._selection.rect.x=r,this._selection.rect.width=a-r),"bottom"==this._selectionStart.stype&&(r=Math.min(i.x,e.x),a=Math.max(i.x,e.x),l=Math.min(i.y,e.y),h=(c=Math.max(i.y,e.y))-l,d=(o=a-r)/i.width,_=h/i.height,this._selection.rect.x=r,this._selection.rect.y=l,this.key_shift?(d<_?(this._selection.rect.width=o,this._selection.rect.height=i.height*d):(this._selection.rect.width=i.width*_,this._selection.rect.height=h),this._selection.rect.x=i.x,this._selection.rect.y=i.y):(this._selection.rect.width=a-r,this._selection.rect.height=c-l)),"mbottom"==this._selectionStart.stype&&(l=Math.min(i.y,e.y),c=Math.max(i.y,e.y),this._selection.rect.y=l,this._selection.rect.height=c-l),"left"==this._selectionStart.stype&&(r=Math.min(i.x+i.width,e.x),a=Math.max(i.x+i.width,e.x),l=Math.min(i.y,e.y),h=(c=Math.max(i.y,e.y))-l,d=(o=a-r)/i.width,_=h/i.height,this._selection.rect.x=r,this._selection.rect.y=l,this.key_shift?(d<_?(this._selection.rect.width=o,this._selection.rect.height=i.height*d):(this._selection.rect.width=i.width*_,this._selection.rect.height=h),this._selection.rect.x=i.x+i.width-this._selection.rect.width,this._selection.rect.y=i.y):(this._selection.rect.width=a-r,this._selection.rect.height=c-l)),"mleft"==this._selectionStart.stype&&(r=Math.min(i.x+i.width,e.x),a=Math.max(i.x+i.width,e.x),this._selection.rect.x=r,this._selection.rect.width=a-r),(i=this._selection.rect).x=Math.floor(i.x),i.y=Math.floor(i.y),i.width=Math.floor(i.width),i.height=Math.floor(i.height),"brush"!=this._selection.type&&this._drawSelection(),"transform"==this._selection.type&&this._transformRect()}}}},{key:"_onWindowMouseUp",value:function(){"transform"==this._selection.type&&this._needSaveSelection()&&this._save(),this._selectionStart&&"resize"==this._selectionStart.stype&&(this._cvResize=null,1==this._selectionStart.hasResize&&(this._save(),this._applyZoom())),this._selectionStart=null,window.removeEventListener("mousemove",this._onWindowMouseMove),window.removeEventListener("mouseup",this._onWindowMouseUp)}},{key:"_onRenderMouseMove",value:function(t){if(this._clientMouseX=t.pageX,this._clientMouseY=t.pageY,!this._selectionStart)if("brush"!=this._selection.type){var e=this._pointGlobalToContentSpace(t),i=this._selectionPointType(e.x,e.y);"resize"==i&&(this._render.style.cursor="nwse-resize"),"none"==i&&(this._render.style.cursor="default"),"top"==i&&(this._render.style.cursor="nwse-resize"),"right"==i&&(this._render.style.cursor="nesw-resize"),"bottom"==i&&(this._render.style.cursor="nwse-resize"),"left"==i&&(this._render.style.cursor="nesw-resize"),"mtop"==i&&(this._render.style.cursor="ns-resize"),"mright"==i&&(this._render.style.cursor="ew-resize"),"mbottom"==i&&(this._render.style.cursor="ns-resize"),"mleft"==i&&(this._render.style.cursor="ew-resize"),"inrect"==i&&(this._render.style.cursor="move")}else this._render.style.cursor="crosshair"}},{key:"_pointGlobalToContentSpace",value:function(t){var e={x:t.clientX,y:t.clientY},i=this._render.getBoundingClientRect(),n=i.width/this.config.width,s=i.height/this.config.height;return e.x-=i.x,e.y-=i.y,e.x/=n,e.y/=s,e.x+=this._render.scrollLeft,e.y+=this._render.scrollTop,e.x-=parseInt(this._contentRender.style.left),e.y-=parseInt(this._contentRender.style.top),e.x/=this.zoom,e.y/=this.zoom,e.x=Math.floor(e.x),e.y=Math.floor(e.y),e}},{key:"_selectionPointType",value:function(t,e){var i=this.zoom<1?this._selection.connerSize/this.zoom:this._selection.connerSize;if(this._pointInRect(t,e,{x:this._imgCanvas.width-i,y:this._imgCanvas.height-i,width:2*i,height:2*i}))return"resize";if(0==this._selection.rect.width||0==this._selection.rect.height)return"none";var n=this._selection.rect;return this._pointInRect(t,e,{x:n.x+n.width-i/2,y:n.y+n.height-i/2,width:i,height:i})?"bottom":this._pointInRect(t,e,{x:n.x+n.width-i/2,y:n.y-i/2,width:i,height:i})?"right":this._pointInRect(t,e,{x:n.x-i/2,y:n.y+n.height-i/2,width:i,height:i})?"left":this._pointInRect(t,e,{x:n.x-i/2,y:n.y-i/2,width:i,height:i})?"top":this._pointInRect(t,e,{x:n.x-i/2,y:n.y-i/2,width:n.width+i/2,height:i})?"mtop":this._pointInRect(t,e,{x:n.x+n.width-i/2,y:n.y-i/2,width:i,height:n.height+i/2})?"mright":this._pointInRect(t,e,{x:n.x-i/2,y:n.y+n.height-i/2,width:n.width+i,height:i})?"mbottom":this._pointInRect(t,e,{x:n.x-i/2,y:n.y-i/2,width:i,height:n.height+i})?"mleft":this._pointInRect(t,e,{x:n.x,y:n.y,width:n.width,height:n.height})?"inrect":"none"}},{key:"_pointInRect",value:function(t,e,i){return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height}},{key:"_drawSelection",value:function(){if(this._clearDrawSelection(),0!=this._selection.rect.width&&0!=this._selection.rect.height){var t=JSON.parse(JSON.stringify(this._selection.rect));t.x*=this.zoom,t.y*=this.zoom,t.x+=parseInt(this._contentRender.style.left),t.y+=parseInt(this._contentRender.style.top),t.width*=this.zoom,t.height*=this.zoom,t.x=Math.floor(t.x),t.y=Math.floor(t.y),t.width=Math.floor(t.width),t.height=Math.floor(t.height);var e=this._selection.connerSize;if("normal"==this._selection.type)return this._selectionCtx.setLineDash([5,4]),this._selectionCtx.strokeStyle="black",this._selectionCtx.lineWidth=1,this._selectionCtx.beginPath(),this._selectionCtx.rect(t.x,t.y,t.width,t.height),void this._selectionCtx.stroke();"transform"!=this._selection.type&&"crop"!=this._selection.type||("crop"==this._selection.type&&(this._selectionCtx.save(),this._selectionCtx.globalAlpha=.4,this._selectionCtx.strokeStyle="#CCCCCC",this._selectionCtx.fillRect(0,0,this._selectionCtx.canvas.width,this._selectionCtx.canvas.height),this._selectionCtx.restore(),this._selectionCtx.clearRect(t.x,t.y,t.width,t.height)),this._selectionCtx.setLineDash([5,4]),this._selectionCtx.strokeStyle="black",this._selectionCtx.lineWidth=1,this._selectionCtx.beginPath(),this._selectionCtx.rect(t.x,t.y,t.width,t.height),this._selectionCtx.stroke(),this._selectionCtx.setLineDash([]),this._selectionCtx.beginPath(),this._selectionCtx.rect(t.x-e/2,t.y-e/2,e,e),this._selectionCtx.rect(t.x+t.width/2-e/2,t.y-e/2,e,e),this._selectionCtx.rect(t.x+t.width-e/2,t.y-e/2,e,e),this._selectionCtx.rect(t.x+t.width-e/2,t.y+t.height/2-e/2,e,e),this._selectionCtx.rect(t.x+t.width-e/2,t.y+t.height-e/2,e,e),this._selectionCtx.rect(t.x+t.width/2-e/2,t.y+t.height-e/2,e,e),this._selectionCtx.rect(t.x-e/2,t.y+t.height-e/2,e,e),this._selectionCtx.rect(t.x-e/2,t.y+t.height/2-e/2,e,e),this._selectionCtx.stroke())}}},{key:"_clearDrawSelection",value:function(){this._selectionCtx.translate(-.5,-.5),this._selectionCtx.clearRect(0,0,this._selectionCtx.canvas.width,this._selectionCtx.canvas.height),this._selectionCtx.translate(.5,.5)}},{key:"_clearSelection",value:function(){if("transform"==this._selection.type&&this._needSaveSelection()&&this._save(),this._cvSelection&&this._cvImgSelection&&this._selection.addNewImage){this._imgCtx.drawImage(this._cvImgSelection,0,0);var t=this._selection.rect;this._imgCtx.drawImage(this._cvSelection,0,0,this._cvSelection.width,this._cvSelection.height,t.x,t.y,t.width,t.height),this._save()}delete this._cvSelection,delete this._cvImgSelection,delete this._selection.addNewImage,this._selection.type="normal",this._selection.rect={x:-1,y:-1,width:0,height:0},this._drawSelection()}},{key:"_needSaveSelection",value:function(){return!!this._selectionStart&&(this._selectionStart.rect.x!=this._selection.rect.x||this._selectionStart.rect.y!=this._selection.rect.y||this._selectionStart.rect.width!=this._selection.rect.width||this._selectionStart.rect.height!=this._selection.rect.height)}},{key:"_setSelectionType",value:function(t){"normal"!=t&&"transform"!=t&&"crop"!=t&&"drag"!=t&&"brush"!=t||this._selection.type!=t&&(this._selection.type=t,"brush"!=t?(this._drawSelection(),this._hideMenuBrush()):(this._clearSelection(),this._showMenuBrush()))}},{key:"_makeSelectionTransform",value:function(){if(0!=this._selection.rect.width&&0!=this._selection.rect.height){this._cvSelection=document.createElement("canvas"),this._cvImgSelection=document.createElement("canvas");var t=this._cvSelection.getContext("2d"),e=this._selection.rect;this._cvSelection.width=e.width,this._cvSelection.height=e.height,t.drawImage(this._imgCanvas,e.x,e.y,e.width,e.height,0,0,e.width,e.height);var i=this._cvImgSelection.getContext("2d");this._cvImgSelection.width=this._imgCanvas.width,this._cvImgSelection.height=this._imgCanvas.height,i.drawImage(this._imgCanvas,0,0,this._imgCanvas.width,this._imgCanvas.height,0,0,this._imgCanvas.width,this._imgCanvas.height),i.save(),i.fillStyle=this._config.contentBackgroundColor,i.fillRect(e.x,e.y,e.width,e.height),i.restore()}}},{key:"zoomIn",value:function(){this.zoom+=.1}},{key:"zoomOut",value:function(){this.zoom-=.1}},{key:"_applyZoom",value:function(){var t=parseInt(this._contentRender.style.width),e=parseInt(this._contentRender.style.height),i=e*this.zoom<this.config.height?0:this._render.scrollTop-(e*this.zoom-this.config.height)/2,n=t*this.zoom<this.config.width?0:this._render.scrollLeft-(t*this.zoom-this.config.width)/2;this._contentRender.style.transform="scale("+this.zoom+")",t*this.zoom<=this.config.width?(this._render.style.overflowX="hidden",this._contentRender.style.left=(this.config.width-t*this.zoom)/2+"px",this._selectionRender.width=this.config.width):(this._render.style.overflowX="scroll",this._contentRender.style.left="0px",this._selectionRender.width=t*this.zoom,this._render.scrollLeft=n+(t*this.zoom-this.config.width)/2),e*this.zoom<=this.config.height?(this._render.style.overflowY="hidden",this._contentRender.style.top=(this.config.height-e*this.zoom)/2+"px",this._selectionRender.height=this.config.height):(this._render.style.overflowY="scroll",this._contentRender.style.top="0px",this._render.scrollTop=i+(e*this.zoom-this.config.height)/2,this._selectionRender.height=e*this.zoom),this._selectionCtx.translate(.5,.5),this._drawSelection()}},{key:"zoom",get:function(){return this._zoom},set:function(t){isNaN(t)||(t<.2&&(t=.2),t>5&&(t=5),this._zoom=t,this._applyZoom())}},{key:"_addKeyboardEvent",value:function(){this._keyDown={},this._codeDown={},window.addEventListener("keypress",this._onkeypress),window.addEventListener("keyup",this._onkeyup),window.addEventListener("keydown",this._onkeydown)}},{key:"_removeKeyboardEvent",value:function(){window.removeEventListener("keypress",this._onkeypress),window.removeEventListener("keyup",this._onkeyup),window.removeEventListener("keydown",this._onkeydown)}},{key:"_onkeypress",value:function(t){}},{key:"_onkeydown",value:function(t){this._keyDown[t.key]=!0,this._codeDown[t.code]=!0,this._handleKeyDown(t)}},{key:"_onkeyup",value:function(t){delete this._keyDown[t.key],delete this._codeDown[t.code]}},{key:"key_shift",get:function(){return!!this._keyDown.Shift}},{key:"key_meta",get:function(){return!!this._keyDown.Meta}},{key:"key_ctrl",get:function(){return!!this._keyDown.Control}},{key:"key_alt",get:function(){return!!this._keyDown.Alt}},{key:"_addDivText",value:function(t,e){var i=this;e||(e=n({},this._textFormat)),t&&0!=t.width&&0!=t.height||(t={x:this._imgCanvas.width/2-100,y:this._imgCanvas.height/2-(e.fontSize+4),width:100,height:e.fontSize+4}),this.textDiv&&this._drawTextDiv(this.textDiv);var s=document.createElement("div");s.classList.add("_mnTextDiv"),s.style.position="absolute",s.style.top=t.y+"px",s.style.left=t.x+"px",s.style.width=t.width+"px",s.style.height="auto",s.style.resize="both",s.style.overflow="auto",s.style.pointerEvents="all",s.style.margin="0px",s.style.border="1px dashed #333333",s.style.outline="none",s.style.textAlign="left",s.setAttribute("spellcheck",!1),s.setAttribute("contenteditable",!0),this._textLayer.appendChild(s),this.textDiv=s,this._setTextFormat(e,s),this._addTextEventListener(s),setTimeout((function(){s.focus(),i.makeDragable(s)}),100),this._clearSelection()}},{key:"_removeDivText",value:function(t){t&&t instanceof HTMLElement&&(this.textDiv=null,this._removeTextEventListener(t),t.parentNode&&t.parentNode.removeChild(t))}},{key:"_setTextFormat",value:function(t,e){t&&(this._textFormat=n({},t),e&&e instanceof HTMLElement&&(t.fontFamily&&(e.style.fontFamily=t.fontFamily),t.fontSize&&(e.style.fontSize=t.fontSize+"px"),t.fontStyle&&(e.style.fontStyle=t.fontStyle),t.fontWeight&&(e.style.fontWeight=t.fontWeight),t.textDecoration&&(e.style.textDecoration=t.textDecoration),t.color&&(e.style.color=t.color),t.backgroundColor&&(e.style.backgroundColor=t.backgroundColor),this._onTextInput()))}},{key:"_addTextEventListener",value:function(t){t.addEventListener("mousedown",this._onTextMouseDown),t.addEventListener("focus",this._onTextFocus),t.addEventListener("blur",this._onTextLostFocus),t.addEventListener("input",this._onTextInput),t.addEventListener("contextmenu",(function(t){t.preventDefault(),t.stopPropagation()}))}},{key:"_removeTextEventListener",value:function(t){t.removeEventListener("mousedown",this._onTextMouseDown),t.removeEventListener("focus",this._onTextFocus),t.removeEventListener("blur",this._onTextLostFocus)}},{key:"_onTextMouseDown",value:function(t){t.stopPropagation()}},{key:"_onTextFocus",value:function(t){this._showTextFormatMenu(),this._hideEditorContextMenu()}},{key:"_onTextLostFocus",value:function(t){}},{key:"_onTextInput",value:function(t){var e=this.textDiv,i=parseInt(e.scrollHeight),n=parseInt(e.clientHeight);parseInt(e.style.fontSize),i>n+10&&(e.style.height=i+10+"px")}},{key:"_drawTextDiv",value:function(t){var e=this;if(t)if(""!=t.textContent.trim()){var i=parseInt(t.style.width),n=parseInt(t.clientHeight),s=parseInt(t.style.left),o=parseInt(t.style.top)+1,h=t.innerHTML.toString();h=h.replaceAll("<br>","<br/>");var r='\n        <svg width="'.concat(i,'" height="').concat(n,"\" style='background-color:").concat(t.style.backgroundColor,'\' xmlns="http://www.w3.org/2000/svg">\n            <foreignObject x="0" y="0" width="').concat(i,'" height="').concat(n,'"> \n                <style>\n                    div {\n                        margin: 0;\n                        padding:0;\n                        font-weight: ').concat(t.style.fontWeight,";\n                        font-family: ").concat(t.style.fontFamily,";\n                        font-size: ").concat(t.style.fontSize,";\n                        font-style:").concat(t.style.fontStyle,";\n                        font-weigth:").concat(t.style.fontWeight,";\n                        text-decoration:").concat(t.style.textDecoration,";\n                        color:").concat(t.style.color,";\n                        backgroundColor:").concat(t.style.backgroundColor,';\n                        word-wrap:break-word;\n                    }\n                </style>\n                <div xmlns="http://www.w3.org/1999/xhtml">\n                    ').concat(h,"\n                </div>\n            </foreignObject>\n        </svg>").replace(/\n/g,"").replace(/"/g,"'"),a=new Image;a.onload=function(){e._imgCtx.drawImage(a,s,o),e._save()},a.src="data:image/svg+xml,".concat(r),this._removeDivText(t)}else this._removeDivText(t)}},{key:"_addImageElement",value:function(t){t&&t instanceof Image&&t instanceof HTMLImageElement&&(this._setSelectionType("normal"),this._cvSelection=document.createElement("canvas"),this._cvSelection.width=t.width,this._cvSelection.height=t.height,this._cvSelection.getContext("2d").drawImage(t,0,0),this._cvImgSelection=document.createElement("canvas"),this._cvImgSelection.width=this._imgCanvas.width,this._cvImgSelection.height=this._imgCanvas.height,this._cvImgSelection.getContext("2d").drawImage(this._imgCanvas,0,0),this._selection.rect={x:0,y:0,width:t.width,height:t.height},this._selection.type="transform",this._selection.addNewImage=!0,this._drawSelection(),this._transformRect())}},{key:"_handleImageFile",value:function(t){var e=this;if(t){var i=t.name?t.name.toLowerCase():" ";if(!(i.indexOf(".jpg")<0&&i.indexOf(".png")<0&&i.indexOf(".jpeg")<0)){var n=new FileReader;n.onload=function(){var t=new Image;t.onload=function(){e._addImageElement(t)},t.src=n.result},n.readAsDataURL(t)}}}},{key:"_createEditorContextMenu",value:function(){var t=this,e=200,i=document.createElement("div");return i.style.width="200px",i.style.height="auto",i.style.position="absolute",i.style.border="1px solid #CCCCCC",i.style.backgroundColor="white",i.style.zIndex=99999999,i.style.boxShadow="3px 3px 3px #888888",this._createContextMenuItemTitle(i,"Xoá","(Delete)",e,(function(){var e=t._selection.type;"normal"==e||"transform"==e?t._clearRect():"crop"==e&&t._cropRect(),t._hideEditorContextMenu()})),this._createContextMenuItemTitle(i,"Cắt ảnh","(Ctr+R)",e,(function(){var e=t._selection.type;"normal"==e?t._setSelectionType("crop"):"crop"==e&&t._cropRect(),t._hideEditorContextMenu()})),this._createContextMenuItemTitle(i,"Cắt vùng chọn","(Ctr D)",e,(function(){"normal"==t._selection.type&&t._delmidRect(),t._hideEditorContextMenu()})),this._createContextMenuItemTitle(i,"Thêm chữ","(Ctr A)",e,(function(){t._addText(),t._hideEditorContextMenu()})),this._createContextMenuItemTitle(i,"Thêm ảnh","(Ctr I)",e,(function(){t._fileInput.click(),t._hideEditorContextMenu()})),this._createContextMenuItemTitle(i,"Zoom 100%","(Ctr O)",e,(function(){t.zoom=1,t._hideEditorContextMenu()})),this._createContextMenuItemTitle(i,"Tải ảnh","(Ctr E)",e,(function(){t._downloadPNG(t.exportImage()),t._hideEditorContextMenu()})),i}},{key:"_showEditorContextMenu",value:function(){this._edMenu||(this._edMenu=this._createEditorContextMenu()),this._edMenu.parentNode||document.body.appendChild(this._edMenu),this._edMenu.style.top=this._clientMouseY+"px",this._edMenu.style.left=this._clientMouseX+10+"px"}},{key:"_hideEditorContextMenu",value:function(){this._edMenu&&this._edMenu.parentNode&&this._edMenu.parentNode.removeChild(this._edMenu)}},{key:"_createContextMenuItemTitle",value:function(t,e,i,n,s){var o=document.createElement("div");o.style.width=n-20+"px",o.style.height="wrap-content",o.style.backgroundColor="white",o.style.position="relative",o.style.color="#333333",o.style.padding="10px",o.style.fontSize="15px",o.style.letterSpacing="0.5",o.style.fontFamily="Arial",o.style.cursor="pointer",o.style.borderBottom="1px solid #CCCCCC",o.style.display="flex",o.style.flexDirection="row",o.style.justifyContent="space-between",t.appendChild(o);var h=document.createElement("span");h.textContent=e;var r=document.createElement("span");r.textContent=i,o.appendChild(h),o.appendChild(r),o.addEventListener("mousemove",(function(t){o.style.backgroundColor="#dddbdb",o.style.color="#666666"})),o.addEventListener("mouseout",(function(t){o.style.backgroundColor="white",o.style.color="#333333"})),o.addEventListener("mousedown",(function(t){o.style.backgroundColor="white",o.style.color="#333333",s&&s(),t.preventDefault(),t.stopPropagation()}))}},{key:"_createTextFormatMenu",value:function(){var t=this,e=document.createElement("div");e.style.position="absolute",e.style.width="640px",e.style.height="25px",e.style.backgroundColor="white",e.style.border="1px solid #AAAAAA",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.padding="8px",e.style.fontFamily="Arial",e.style.zIndex=99999999,e.style.boxSizing="unset",e.style.boxShadow="3px 3px 3px #888888";var i=document.createElement("select");i.style.fontSize="14px",i.style.width="120px",i.style.borderColor="#CCCCCC",e.appendChild(i),e.familySelect=i,i.addEventListener("change",(function(){t._onMenuFormatChange()})),this._setHtmlSelectData(i,[{value:"Arial",label:"Arial"},{value:"Verdana",label:"Verdana"},{value:"Helvetica",label:"Helvetica"},{value:"Tahoma",label:"Tahoma"},{value:"Trebuchet MS",label:"Trebuchet MS"},{value:"Times New Roman",label:"Times New Roman"},{value:"Georgia",label:"Georgia"},{value:"Garamond",label:"Garamond"},{value:"Courier New",label:"Courier New"},{value:"Brush Script MT",label:"Brush Script MT"}]);var n=document.createElement("select");n.style.fontSize="14px",n.style.width="60px",n.style.marginLeft="8px",n.style.borderColor="#CCCCCC",e.appendChild(n),e.sizeSelect=n,n.addEventListener("change",(function(){t._onMenuFormatChange()}));for(var s=[8,9,10,11,12,14,16,18,20,22,24,26,28,36,48,72],o=[],h=0;h<s.length;h++)o.push({value:s[h],label:s[h]});this._setHtmlSelectData(n,o),n.value=this._textFormat.fontSize;var r=document.createElement("input");r.setAttribute("type","color"),r.value="#000000",r.style.marginLeft="8px",r.style.height="22px",r.style.width="50px",r.classList.add("_mnInput"),e.appendChild(r),e.colorInput=r,r.addEventListener("input",(function(){t._onMenuFormatChange()}));var a=document.createElement("div");a.textContent="B",a.style.fontWeight="Bold",a.style.width="20px",a.style.height="20px",a.style.marginLeft="8px",a.style.border="1px solid #CCCCCC",a._selected=!1,a.style.cursor="pointer",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",e.appendChild(a),e.boldButton=a,a.addEventListener("mouseup",(function(){a._selected=!a._selected,a.style.borderColor=a._selected?"#333333":"#CCCCCC",t._onMenuFormatChange()}));var l=document.createElement("div");l.textContent="I",l.style.fontStyle="italic",l.style.width="20px",l.style.height="20px",l.style.marginLeft="8px",l.style.border="1px solid #CCCCCC",l._selected=!1,l.style.cursor="pointer",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",e.appendChild(l),e.italicButton=l,l.addEventListener("mouseup",(function(){l._selected=!l._selected,l.style.borderColor=l._selected?"#333333":"#CCCCCC",t._onMenuFormatChange()}));var c=document.createElement("div");c.textContent="U",c.style.textDecoration="underline",c.style.width="20px",c.style.height="20px",c.style.marginLeft="8px",c.style.border="1px solid #CCCCCC",c._selected=!1,c.style.cursor="pointer",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",e.appendChild(c),e.undelineButton=c,c.addEventListener("mouseup",(function(){c._selected=!c._selected,c.style.borderColor=c._selected?"#333333":"#CCCCCC",t._onMenuFormatChange()})),(d=document.createElement("div")).textContent="Nền trong suốt ",d.style.marginLeft="16px",e.appendChild(d);var d,_=document.createElement("input");_.setAttribute("type","checkbox"),_.checked=!0,_.style.width=_.style.height="16px",_.style.marginLeft="8px",e.appendChild(_),e.bgCb=_,_.addEventListener("change",(function(){t._onMenuFormatChange()})),(d=document.createElement("div")).textContent="Màu nền ",d.style.marginLeft="16px",e.appendChild(d);var u=document.createElement("input");return u.setAttribute("type","color"),u.value="#FFFFFF",u.style.marginLeft="8px",u.style.height="22px",u.style.width="50px",u.classList.add("_mnInput"),e.appendChild(u),e.bgColorInput=u,u.addEventListener("input",(function(){t._onMenuFormatChange()})),e}},{key:"_setHtmlSelectData",value:function(t,e){for(var i=0;i<e.length;i++){var n=document.createElement("option");n.setAttribute("value",e[i].value),n.textContent=e[i].label,t.appendChild(n)}}},{key:"_showTextFormatMenu",value:function(){if(this._texMenu||(this._texMenu=this._createTextFormatMenu()),this._texMenu.parentNode||document.body.appendChild(this._texMenu),this.textDiv){var t=this.textDiv.getBoundingClientRect(),e=parseInt(this._texMenu.style.width);t.x+=document.documentElement.scrollLeft,t.y+=document.documentElement.scrollTop,t.y-=parseInt(this._texMenu.style.height)+30,t.x=t.x+e>window.innerWidth?window.innerWidth-e-100:t.x,this._texMenu.style.top=t.y+"px",this._texMenu.style.left=t.x+"px"}}},{key:"_hideTextFormatMenu",value:function(){this._texMenu&&this._texMenu.parentNode&&this._texMenu.parentNode.removeChild(this._texMenu)}},{key:"_onMenuFormatChange",value:function(){var t={fontFamily:this._texMenu.familySelect.value,fontSize:this._texMenu.sizeSelect.value,color:this._texMenu.colorInput.value,fontWeight:this._texMenu.boldButton._selected?"bold":"normal",fontStyle:this._texMenu.italicButton._selected?"italic":"normal",textDecoration:this._texMenu.undelineButton._selected?"underline":"normal",backgroundColor:1==this._texMenu.bgCb.checked?"transparent":this._texMenu.bgColorInput.value};this.textDiv&&this._setTextFormat(t,this.textDiv),this.textDiv.focus()}},{key:"_createMenuBrush",value:function(){var t=this,e=document.createElement("div");e.style.position="absolute",e.style.width="640px",e.style.height="25px",e.style.backgroundColor="white",e.style.border="1px solid #AAAAAA",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.padding="8px",e.style.fontFamily="Arial",e.style.zIndex=99999999,e.style.boxSizing="unset",e.style.boxShadow="3px 3px 3px #888888";var i=document.createElement("div");i.textContent="Cỡ nét",i.style.marginLeft="16px",e.appendChild(i);var n=document.createElement("select");n.style.fontSize="14px",n.style.width="60px",n.style.marginLeft="8px",n.style.borderColor="#CCCCCC",e.appendChild(n),e.sizeStroke=n,n.addEventListener("change",(function(){t._onMenuBrushChange()}));for(var s=[1,2,4,6,8,10,14,18,20,28,46,60],o=[],h=0;h<s.length;h++)o.push({value:s[h],label:s[h]});this._setHtmlSelectData(n,o),n.value=1;var r=document.createElement("div");r.textContent="Nét đứt",r.style.marginLeft="8px",e.appendChild(r);var a=document.createElement("input");a.setAttribute("type","checkbox"),a.checked=!1,a.style.width=a.style.height="16px",a.style.marginLeft="8px",e.appendChild(a),e.dashedCb=a,a.addEventListener("change",(function(){t._onMenuBrushChange()}));var l=document.createElement("div");l.textContent="Màu Viền",l.style.marginLeft="24px",e.appendChild(l);var c=document.createElement("input");c.setAttribute("type","checkbox"),c.checked=!0,c.style.width=c.style.height="16px",c.style.marginLeft="8px",e.appendChild(c),e.strokeCb=c,c.addEventListener("change",(function(){t._onMenuBrushChange()}));var d=document.createElement("input");d.setAttribute("type","color"),d.value="#FF0000",d.style.marginLeft="8px",d.style.height="20px",d.style.width="50px",d.classList.add("_mnInput"),e.appendChild(d),e.colorStroke=d,d.addEventListener("input",(function(){t._onMenuBrushChange()}));var _=document.createElement("div");_.textContent="Màu Nền",_.style.marginLeft="24px",e.appendChild(_);var u=document.createElement("input");u.setAttribute("type","checkbox"),u.checked=!1,u.style.width=u.style.height="16px",u.style.marginLeft="8px",e.appendChild(u),e.fillCb=u,u.addEventListener("change",(function(){t._onMenuBrushChange()}));var g=document.createElement("input");return g.setAttribute("type","color"),g.value="#FF0000",g.style.marginLeft="8px",g.style.height="20px",g.style.width="50px",g.classList.add("_mnInput"),e.appendChild(g),e.colorFill=g,g.addEventListener("input",(function(){t._onMenuBrushChange()})),e}},{key:"_hideMenuBrush",value:function(){this._render.style.cursor="default",this._brushMenu&&this._brushMenu.parentNode&&(this._brushMenu.parentNode.removeChild(this._brushMenu),this._selection.rect.width=0,this._selection.rect.height=0,this._drawSelection())}},{key:"_showMenuBrush",value:function(){this._selection.type="brush",this._render.style.cursor="crosshair",this._brushMenu||(this._brushMenu=this._createMenuBrush()),this._brushMenu.parentNode||document.body.appendChild(this._brushMenu);var t=this._render.getBoundingClientRect(),e=parseInt(this._render.style.width);t.x+=document.documentElement.scrollLeft,t.y+=document.documentElement.scrollTop,t.y-=parseInt(this._brushMenu.style.height)+30,t.x=t.x+e>window.innerWidth?window.innerWidth-e-100:t.x,this._brushMenu.style.top=t.y+"px",this._brushMenu.style.left=t.x+"px"}},{key:"_onMenuBrushChange",value:function(){}},{key:"_canEdit",value:function(t){return t instanceof Image||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement}},{key:"_downloadPNG",value:function(t){var e=document.createElement("a");e.href=t,e.download="Image.png",e.click()}},{key:"_startEditImage",value:function(t,e){if(t&&this._canEdit(t)){e||(e=!1),this._config.width=this._config.width>0?this._config.width:t.width,this._config.height=this._config.height>0?this._config.height:t.height,this._applyConfig();var i=t.width!=this._imgCtx.canvas.width||t.height!=this._imgCtx.canvas.height;this._imgCtx.canvas.width=t.width,this._imgCtx.canvas.height=t.height,this._imgCtx.drawImage(t,0,0,t.width,t.height,0,0,this._imgCtx.canvas.width,this._imgCtx.canvas.height),e||(this._save(),this._addEventListener()),this._contentRender.style.width=t.width+"px",this._contentRender.style.height=t.height+"px",i&&(this.zoom=t.width<=this._config.width?1:this._config.width/t.width),this._selection.type="normal",this._selection.rect={x:-1,y:-1,width:0,height:0},this._drawSelection(),this._stateProcessing=1}}},{key:"_save",value:function(){this._his.length>20&&this._his.shift(),this._hisIndex<this._his.length-1&&this._his.splice(this._hisIndex+1,this._his.length),this._his.push(this._imgCanvas.toDataURL(this._config.exportType,this._config.exportQuality)),this._hisIndex=this._his.length-1,this._fireChange(this._his[this._hisIndex])}},{key:"_undo",value:function(){var t=this;if(!(1==this._his.length||this._hisIndex<=0)){this._hisIndex-=1;var e=this._his[this._hisIndex];this._fireChange(e);var i=new Image;i.onload=function(){t._startEditImage(i,!0)},i.src=e}}},{key:"_redo",value:function(){var t=this;if(!(1==this._his.length||this._hisIndex>=this._his.length-1)){this._hisIndex+=1;var e=this._his[this._hisIndex];this._fireChange(e);var i=new Image;i.onload=function(){t._startEditImage(i,!0)},i.src=e}}},{key:"_copy",value:function(){}},{key:"_paste",value:function(){}},{key:"_doSelection",value:function(){0!=this._selection.rect.width&&0!=this._selection.rect.height&&("transform"==this._selection.type&&this._transformRect(),this._drawSelection())}},{key:"_moveUp",value:function(){this.textDiv&&(this.textDiv.style.top=parseInt(this.textDiv.style.top)-1+"px"),0!=this._selection.rect.width&&0!=this._selection.rect.height&&(this._selectionStart=JSON.parse(JSON.stringify(this._selection)),this._selection.rect.y-=1,this._doSelection())}},{key:"_moveDown",value:function(){this.textDiv&&(this.textDiv.style.top=parseInt(this.textDiv.style.top)+1+"px"),0!=this._selection.rect.width&&0!=this._selection.rect.height&&(this._selectionStart=JSON.parse(JSON.stringify(this._selection)),this._selection.rect.y+=1,this._doSelection())}},{key:"_moveLeft",value:function(){this.textDiv&&(this.textDiv.style.left=parseInt(this.textDiv.style.left)-1+"px"),0!=this._selection.rect.width&&0!=this._selection.rect.height&&(this._selectionStart=JSON.parse(JSON.stringify(this._selection)),this._selection.rect.x-=1,this._doSelection())}},{key:"_moveRight",value:function(){this.textDiv&&(this.textDiv.style.left=parseInt(this.textDiv.style.left)+1+"px"),0!=this._selection.rect.width&&0!=this._selection.rect.height&&(this._selectionStart=JSON.parse(JSON.stringify(this._selection)),this._selection.rect.x+=1,this._doSelection())}},{key:"_handleKeyDown",value:function(t){return"Equal"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?(this.zoomIn(),void t.preventDefault()):"Minus"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?(this.zoomOut(),void t.preventDefault()):"ArrowUp"==t.code?(this._moveUp(),void t.preventDefault()):"ArrowLeft"==t.code?(this._moveLeft(),void t.preventDefault()):"ArrowRight"==t.code?(this._moveRight(),void t.preventDefault()):"ArrowDown"==t.code?(this._moveDown(),void t.preventDefault()):void("Backspace"!=t.code?"KeyR"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?this._setSelectionType("crop"):"KeyZ"==t.code&&this.key_ctrl&&(this.key_shift||this.key_meta)?this._redo():"KeyZ"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?this._undo():"Enter"!=t.code?"KeyD"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)&&"normal"==this._selection.type?this._delmidRect():"KeyT"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?this._addText():"KeyI"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?this._fileInput.click():"KeyO"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?this.zoom=1:"KeyE"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)?this._downloadPNG(this.exportImage()):"KeyB"==t.code&&(this.key_ctrl||this.key_shift||this.key_meta)&&("brush"!=this._selection.type?this._setSelectionType("brush"):this._setSelectionType("normal")):"crop"==this._selection.type&&this._cropRect():"normal"==this._selection.type||"transform"==this._selection.type?this._clearRect():"crop"==this._selection.type&&this._cropRect())}},{key:"_clearRect",value:function(t){t||(t=this._config.contentBackgroundColor);var e=this._selection.rect;this._imgCtx&&0!=e.width&&0!=e.height&&(this._imgCtx.save(),this._imgCtx.fillStyle=t,this._imgCtx.fillRect(e.x,e.y,e.width,e.height),this._imgCtx.restore(),this._save())}},{key:"_makeTransform",value:function(){this._makeSelectionTransform(),this._setSelectionType("transform")}},{key:"_transformRect",value:function(){if(this._cvSelection&&this._cvImgSelection){var t=this._selection.rect;this._imgCtx.clearRect(0,0,this._imgCanvas.width,this._imgCanvas.height),this._imgCtx.drawImage(this._cvImgSelection,0,0,this._cvImgSelection.width,this._cvImgSelection.height,0,0,this._cvImgSelection.width,this._cvImgSelection.height),this._imgCtx.drawImage(this._cvSelection,0,0,this._cvSelection.width,this._cvSelection.height,t.x,t.y,t.width,t.height)}}},{key:"_cropRect",value:function(){var t=this;if("crop"!=!this._selection.type){var e=document.createElement("canvas"),i=e.getContext("2d"),s=n({},this._selection.rect);s.x=s.x<=0?0:s.x,s.y=s.y<=0?0:s.y,s.width=s.x+s.width>this._imgCanvas.width?this._imgCanvas.width-s.x:s.width,s.height=s.y+s.height>this._imgCanvas.height?this._imgCanvas.height-s.x:s.height,e.width=s.width,e.height=s.height,i.drawImage(this._imgCanvas,s.x,s.y,s.width,s.height,0,0,s.width,s.height);var o=new Image;o.onload=function(){t._startEditImage(o)},o.src=e.toDataURL()}}},{key:"_delmidRect",value:function(){var t=this;if(0!=this._selection.rect.width&&0!=this._selection.rect.height){var e=document.createElement("canvas"),i=e.getContext("2d"),s=n({},this._selection.rect);if(!(s.width>=this._imgCanvas.width&&s.height>=this._imgCanvas.height)&&(s.width-this._imgCanvas.width>-30?(s.x=0,s.width=this._imgCanvas.width,s.y=s.y<0?0:s.y,s.height=s.y+s.height>this._imgCanvas.height?this._imgCanvas.height-s.y:s.height):s.height-this._imgCanvas.height>-30&&(s.y=0,s.height=this._imgCanvas.height,s.x=s.x<0?0:s.x,s.width=s.x+s.width>this._imgCanvas.width?this._imgCanvas.width-s.x:s.width),s.height==this._imgCanvas.height||s.width==this._imgCanvas.width)){s.height==this._imgCanvas.height?(e.width=this._imgCanvas.width-s.width,e.height=s.height,i.drawImage(this._imgCanvas,0,0,s.x,this._imgCanvas.height,0,0,s.x,this._imgCanvas.height),i.drawImage(this._imgCanvas,s.x+s.width,0,this._imgCanvas.width-(s.x+s.width),this._imgCanvas.height,s.x,0,this._imgCanvas.width-(s.x+s.width),this._imgCanvas.height)):s.width==this._imgCanvas.width&&(e.width=this._imgCanvas.width,e.height=this._imgCanvas.height-s.height,i.drawImage(this._imgCanvas,0,0,this._imgCanvas.width,s.y,0,0,this._imgCanvas.width,s.y),i.drawImage(this._imgCanvas,0,s.y+s.height,this._imgCanvas.width,this._imgCanvas.height-(s.y+s.height),0,s.y,this._imgCanvas.width,this._imgCanvas.height-(s.y+s.height)));var o=new Image;o.onload=function(){t._startEditImage(o)},o.src=e.toDataURL()}}}},{key:"_addText",value:function(){"brush"==this._selection.type&&this._setSelectionType("normal"),this._addDivText(n({},this._selection.rect),this._textFormat)}},{key:"_fireChange",value:function(t){"change"==this._config.autoUpdateSource&&this._updateSource(),this._saveHandler&&this._saveHandler.call(null,t,this._source)}},{key:"_updateSource",value:function(t){var e=this;if((this._source instanceof Image||this._source instanceof HTMLImageElement)&&(this._source.src=t),this._source instanceof HTMLCanvasElement){var i=new Image;i.onload=function(){e._source.getContext("2d").drawImage(i,0,0)},i.src=t}}},{key:"makeEditable",value:function(t,e){var i=this,n=[];"array"==typeof t&&(n=t),"string"==typeof t&&(0==t.indexOf("#")?n.push(document.getElementById(t.substring(1))):n=0==t.indexOf(".")?document.getElementsByClassName(t.substring(1)):document.getElementsByTagName(t)),this._canEdit(t)&&n.push(t),0!=n.length&&Array.from(n).forEach((function(t){i._canEdit(t)&&(t._mnOptions=e,t.addEventListener("mousedown",i._onElementMouseDown),t.addEventListener("click",i._onElementMouseClick))}))}},{key:"_onElementMouseClick",value:function(t){t.preventDefault(),t.stopPropagation()}},{key:"_onElementMouseDown",value:function(t){var e=t.currentTarget;e._mnOptions=e._mnOptions?e._mnOptions:{},this.startSession(e,e._mnOptions),t.preventDefault(),t.stopPropagation()}},{key:"clearEditable",value:function(t){var e=this,i=[];"array"==typeof t&&(i=t),"string"==typeof t&&(0==t.indexOf("#")?i.push(document.getElementById(t.substring(1))):i=0==t.indexOf(".")?document.getElementsByClassName(t.substring(1)):document.getElementsByTagName(t)),this._canEdit(t)&&i.push(t),0!=i.length&&Array.from(i).forEach((function(t){e._canEdit(t)&&(delete t._mnOptions,t.removeEventListener("click",e._onElementEditClick))}))}},{key:"startSession",value:function(t,e){var i=this;if(0!=this._stateProcessing){if(this.stopSession(),e||(e={}),!t||""==t){var n=document.createElement("canvas");n.width=this._config.blankWidth,n.height=this._config.blankHeight,e.src=n}if("string"==typeof t&&(e={src:t}),this._canEdit(t)&&(e={src:t}),e.change&&"function"==typeof e.change&&(this._saveHandler=e.change),e.appendTo&&e.appendTo instanceof HTMLElement&&(this._parent=e.appendTo),e.parent&&e.parent instanceof HTMLElement&&(this._parent=e.parent),this.setConfig(e),this._stateProcessing=0,"string"==typeof e.src&&this._retryLoadImage(e.src,(function(t){t?(i._parent||(i._parent=document.body),i._editor.parentNode&&i._editor.parentNode.removeChild(i._editor),i._parent.appendChild(i._editor),i._startEditImage(t)):(alert("Tải ảnh bị lỗi ! "+e.src),i._reset())})),this._canEdit(e.src)){var s=e.src,o=s.width,h=s.height;this.setConfig({width:o,height:h});var r=s instanceof Image||HTMLImageElement?s.src:s.toDataURL();this._retryLoadImage(r,(function(t){if(t){i._source=s;var e=document.createElement("canvas");e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,t.width,t.height);var n=o/t.width,r=h/t.height;i._zoom=Math.min(n,r),i._startEditImage(e),i._parent?(i._editor.parentNode&&i._editor.parentNode.removeChild(i._editor),i._parent.appendChild(i._editor)):(s.parentNode?(i.copyAttributes(s,i._editor),i._editor.style.width=o+"px",i._editor.style.height=h+"px",i._isReplaceSource=!0,s.parentNode.replaceChild(i._editor,s),i._fixCssEditorInline()):(i._parent=document.body,i._editor.parentNode&&i._editor.parentNode.removeChild(i._editor),i._parent.appendChild(i._editor)),i._applyZoom())}else alert("Tải ảnh bị lỗi ! "),i._reset()}))}var a=this._render.getBoundingClientRect();this._clientMouseX=a.x,this._clientMouseY=a.y}}},{key:"_retryLoadImage",value:function(t,e,i){var n=this,s=new Image;s.onload=function(){e&&e(s)},s.onerror=function(){if(i)e&&e();else{var s=t+"?t="+(new Date).getTime();n._retryLoadImage(s,e,!0)}},s.crossOrigin="anonymous",s.src=t}},{key:"_fixCssEditorInline",value:function(){var t=window.getComputedStyle(this._editor,null).getPropertyValue("text-align");"center"==t?this._editor.style.margin="auto":"right"==t&&(this._editor.style.float="right")}},{key:"stopSession",value:function(){this._reset()}},{key:"exportImage",value:function(t,e,i){t&&"string"==typeof t||(t=this._config.exportType),e&&!isNaN(e)||(e=this._config.exportQuality),i||(i={}),i.rect||(i.rect={x:0,y:0,width:this._imgCanvas.width,height:this._imgCanvas.height}),(isNaN(i.rect.x)||i.rect.x<0)&&(i.rect.x=0),(isNaN(i.rect.y)||i.rect.y<0)&&(i.rect.y=0),(isNaN(i.rect.width)||i.rect.width<=0)&&(i.rect.width=this._imgCanvas.width),(isNaN(i.rect.height)||i.rect.height<=0)&&(i.rect.height=this._imgCanvas.height),(isNaN(i.scale)||i.scale<=0)&&(i.scale=1);var n=document.createElement("canvas");return n.width=i.rect.width*i.scale,n.height=i.rect.height*i.scale,n.getContext("2d").drawImage(this._imgCanvas,i.rect.x,i.rect.y,i.rect.width,i.rect.height,0,0,n.width,n.height),n.toDataURL(t,e)}}])&&s(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}(),r=function(){return new h};return e})()));