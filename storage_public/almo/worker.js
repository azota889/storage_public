function log(b){var e=(new Date).toISOString();b=e.substr(e.length-13,13)+"--"+b;console.log(b)}var opencvloaded=!1,isInit=!1,isProcessing=!1,urlBase="https://azota889.github.io/storage_public/almo/",checkOpencv=setInterval(function(){null!=cv&&null!=cv.Mat&&void 0!=cv.Mat&&void 0!=cv.CascadeClassifier?(clearInterval(checkOpencv),opencvloaded=!0,init(),self.postMessage({cmd:"opencvloaded"})):log("loading opencv")},1E3);
onmessage=function(b){if(b.data)switch(b.data.cmd){case "processimage":opencvloaded&&isInit&&!isProcessing&&detectEye(b.data.obj)}};var eyeClassifier=null,faceClassifier=null;
function init(){createFileFromUrl("haarcascade_eye.xml","haarcascade_eye.xml",function(){eyeClassifier=new cv.CascadeClassifier;eyeClassifier.load("haarcascade_eye.xml")});createFileFromUrl("haarcascade_frontalface_default.xml","haarcascade_frontalface_default.xml",function(){faceClassifier=new cv.CascadeClassifier;faceClassifier.load("haarcascade_frontalface_default.xml");isInit=!0})}
createFileFromUrl=function(b,e,c){var a=new XMLHttpRequest;a.open("GET",urlBase+e,!0);a.responseType="arraybuffer";a.onload=function(f){a=this;4===a.readyState&&(200===a.status?(f=new Uint8Array(a.response),cv.FS_createDataFile("/",b,f,!0,!1,!1),c()):console.error("Failed to load "+e+" status: "+a.status))};a.send()};
function detectEye(b){isProcessing=!0;var e=cv.matFromImageData(b.imagedata),c=new cv.Mat;cv.cvtColor(e,c,cv.COLOR_RGBA2GRAY);b.isMobile||cv.resize(c,c,new cv.Size(3*c.cols,3*c.rows),0,0,cv.INTER_AREA);foundEyes=[];foundFace=[];if(faceClassifier){var a=new cv.RectVector,f=c.clone();faceClassifier.detectMultiScale(f,a);for(var g=0;g<a.size();g++){var d=a.get(g);foundFace.push({x:d.x,y:d.y,width:d.width,height:d.height})}f["delete"]();a["delete"]()}if(0==foundFace.length&&eyeClassifier){a=new cv.RectVector;
f=c.clone();eyeClassifier.detectMultiScale(f,a);for(g=0;g<a.size();g++)d=a.get(g),0==foundEyes.length&&foundEyes.push({x:d.x,y:d.y,width:d.width,height:d.height});f["delete"]();a["delete"]()}e["delete"]();c["delete"]();isProcessing=!1;self.postMessage({cmd:"processimage",obj:{timestamp:b.timestamp,index:b.index,startTime:b.startTime,foundEyes:foundEyes,foundFace:foundFace}})}importScripts(urlBase+"opencv.js");
